---
title: "DataAnalysis_InsectData"
author: "JacquelineHoppenreijs"
date: "`r Sys.Date()`"
output: word_document
---

```{r setting the scene, include = FALSE}
# Install and load necessary packages
# pacman helps manage and load multiple packages efficiently
if (!require("pacman")) install.packages("pacman")  # Install pacman if not already installed
library(pacman)

p_load(readxl, tidyverse, plyr, dplyr, lattice, ggplot2, png, colorblindcheck, broom, vegan, patchwork, scales)

# Check whether the used colours are colourblindness-friendly
palette <- c("#104e8b", "#458b00", "#eead0e", "#9F2B68") 
palette_check(palette)
palette_bivariate_plot(palette)

# Function to check which packages and versions are included
package_versions <- function(packages=NULL, base=FALSE, sort=FALSE) {
    if (is.null(packages))
        packages <- names(sessionInfo()$otherPkgs)
    if (base)
        packages <- c("base", packages)
    if (sort)
        packages <- sort(packages)
    if (!is.null(packages)) {
        tmp <- data.frame(sapply(sapply(packages, packageVersion, simplify=FALSE), as.character))
        colnames(tmp) <- "version"
        data.frame(package=rownames(tmp), version=tmp[1], row.names=NULL)
    }
}

cat("Packages and versions in use:\n")
print(package_versions())

# If you get any warnings about packages not being up to date, you can update to the newest version by typing the following in the console: update.packages("package_name").
```

# File description
This Rmarkdown document can be used to analyse plant and insect data, and is tailored for use in the FORMAS project "Lära och Leva med Insekter", led by Peter Lampert (Karlstad University). He can be contacted at peter.lampert@kau.se. The document was originally written by Jacqueline Hoppenreijs (jacquelinehthoppenreijs@gmail.com).

# Software specifications
Built with R version `r getRversion()`. 

Used packages + versions: `r paste(package_versions())`.

# Data description
The data used in this document is collected in 2024, and describes the vegetation and occurrence of insects in four habitat types: - Sälg (1st)\ - Älvkant (1st)\ - Ö (4st)\ - Gräsmatta (1st bruksgräsmatta and 1st paradgräsmatta). Data is analysed on the level of vegetation, insects and pollinators.\\ The same code can be used for data collected in different years, as long as it's formatted in a similar way.

## Structure
The dataset used here is compiled in long format (as opposed to wide). Every observation is in its own row, which means that a find of eight honeybees in one spot takes eight rows, rather than one row and a column that states the number of individuals observed. Further, data is separated based on species groups: vegetation is analysed in one way and (thus) has its own sheet in the dataset, and insects are analysed in another way and (thus) have their own sheet in the dataset. A third sheet can be used to give information about the sites, weather conditions and observers, for example. 

```{r check home folder, include = FALSE}
# Check current working directory
cat("Your current working directory is:\n")
print(getwd())

# Instructions for setting the correct working directory
cat("\nIf the directory above does not point to the folder containing your data, set the correct one using setwd().\n")
cat("For example:\n")
cat('setwd("C:/path/to/your/folder")\n')

# Example code to manually set the working directory
# Uncomment and replace with your path if necessary
# setwd("C:/path/to/your/folder")
```

# Visualisation of vegetation data

```{r loading plant data, include = FALSE}
# Try to load the Excel file. Check if the file exists first.
file_path <- "./Data/LoL_data_JH20241031.xlsx"
if (!file.exists(file_path)) {
    stop("Error: File not found. Please check that the file exists in the specified directory:\n", file_path)
}

# Load vegetation data
plant_data_2024 <- read_excel("./Data/LoL_data_JH20241031.xlsx", sheet = "LoL_veginfo") # This line specifies which file to upload, as well as the sheet of interest
plant_data_2024$Site <- as.factor(plant_data_2024$Site)
plant_data_2024$Site_type <- as.factor(plant_data_2024$Site_type)
plant_data_2024$Week <- as.factor(plant_data_2024$Week)
plant_data_2024$Species_sv <- as.factor(plant_data_2024$Species_sv)
plant_data_2024$Family_lt <- as.factor(plant_data_2024$Family_lt)
plant_data_2024$Type <- as.factor(plant_data_2024$Type)

cat("Vegetation data successfully loaded. Here’s a preview of the data structure:\n")
str(plant_data_2024)

plant_data_2024 <- plant_data_2024 %>% # Exclude plant species that are grasses or trees, so that we only include herbs
  filter(Type != "Grass" | is.na(Type)) %>% 
  filter(Type != "Träd" | is.na(Type))

# If you don't want to exclude those species, or want to undo any other line of code, you can put a # in front of the lines. Of course, you can delete them as well, but if you want to use the old lines later, using # can save a lot of time.

str(plant_data_2024) # See what the dataset looks like

site_colors <- c("Bruksgräsmatta" = "#9F2B68", # Set colours for the plots that are made later on
                   "Paradgräsmatta" = "#9F2B68", 
                   "Älvkant" = "#104e8b",        
                   "Ö_1" = "#458b00",           
                   "Ö_2" = "#458b00",           
                   "Ö_3" = "#458b00",           
                   "Ö_4" = "#458b00")           

sitetype_colors <- c("Gräsmatta" = "#9F2B68", 
                   "Älvkant" = "#104e8b",        
                   "Ö" = "#458b00")   
```

```{r build plant dataframe, include = FALSE}
df_plants_2024 <- ddply(plant_data_2024, ~ Week*Site_type*Site, summarise, # Summarise the dataset to get numbers per combination of factors (in this case, week number, site type and site)
                         SR = length(unique(Species_sv))) # The newly created variable, species richness (SR)

df_plants_2024 <- df_plants_2024 %>% 
  mutate(Week = as.integer(as.character(Week)))

valid_combinations <- data.frame(
  Site_type = c("Gräsmatta", "Gräsmatta", "Älvkant", "Ö", "Ö", "Ö", "Ö"),
  Site = c("Paradgräsmatta", "Bruksgräsmatta", "Älvkant", "Ö_1", "Ö_2", "Ö_3", "Ö_4"))

df_plants_2024 <- df_plants_2024 %>%
  complete(Week = 18:34, nesting(Site_type, Site), fill = list(SR = 0)) %>%
  semi_join(valid_combinations, by = c("Site_type", "Site"))

str(df_plants_2024) # See what the dataset looks like
```

```{r calculate total number of plant species, include = FALSE}
plant_SR_2024 = length(unique(plant_data_2024$Species_sv)) # Calculate the number of unique plant species in 2024

print(plant_SR_2024)
```

The total number of plant species in the dataset is ` r (plant_SR_2024)`. They are distributed over the different sites as follows:

```{r plotting plant data, per week, include = FALSE}
plot_plantSR_2024 <- ggplot(df_plants_2024, aes(x = as.factor(Week), y = SR, fill = Site)) + # This line selects the variables of interest for the plot and determines the name of the plot
  geom_bar(stat = "identity", position = "dodge") + # This line tells in what type of plot we want to visualise those variables
  scale_y_continuous(name = "Artrikedom (minus gräss och träd)", limits = c(0, 25), breaks = c(5, 10, 15, 20, 25)) + # Title and characteristics of the y-axis
  scale_fill_manual(values = site_colors, ) +
  labs(x = "Vecka", fill = "Lokal") + # Title and characteristics of the x-axis
  theme(legend.position = "bottom") + # Placement of the legend
  theme_classic() + # This line specifies the type of lay-out we want for our plot
    theme(strip.text = element_text(size = 14, face = "bold")) +
    theme(axis.title = element_text(size = 16, face = "bold")) 
# We repeat the name of the plot below to have it printed
```

```{r plotting plant data, per week, II, include = TRUE}
plot_plantSR_2024 
```

Note that there's a gap because no observations were made in week 22 and 23, and every other week after that. 

If we group the vegetation data per *type of site*, rather than per *site*, we find the following: 
```{r build aggregated plant dataframe, include = FALSE}
df_plantsagg_2024 <- ddply(plant_data_2024, ~ Week*Site_type, summarise, 
                         SR = length(unique(Species_sv)))

df_plantsagg_2024 <- df_plantsagg_2024 %>%
  mutate(Week = as.integer(as.character(Week)))

df_plantsagg_2024 <- df_plantsagg_2024 %>%
  complete(Week = 18:34, nesting(Site_type), fill = list(SR = 0)) %>%
  semi_join(valid_combinations, by = c("Site_type"))

df_plantsagg_2024$Site_type <- factor(df_plantsagg_2024$Site_type, levels = c("Gräsmatta", "Älvkant", "Ö"))

str(df_plantsagg_2024)
```

```{r plotting aggregated plant data, per week, I, include = FALSE}
plot_plantaggSR_2024 <- ggplot(df_plantsagg_2024, aes(x = as.factor(Week), y = SR, fill = Site_type)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_y_continuous(name = "Artrikedom (minus gräss och träd)", limits = c(0, 25), breaks = c(5, 10, 15, 20, 25)) +
  scale_fill_manual(values = sitetype_colors, ) +
  labs(x = "Vecka", fill = "Typ av lokal") +
  theme(legend.position = "bottom") + 
  theme_classic() +
    theme(strip.text = element_text(size = 14, face = "bold")) +
    theme(axis.title = element_text(size = 16, face = "bold")) 
# We repeat the name of the plot below to have it printed
```

```{r plotting aggregated plant data, per week, II, include = TRUE}
plot_plantaggSR_2024 
```

# Visualisation of insect data

```{r loading insect data, include = FALSE}
insect_data_2024 <- read_excel("./Data/LoL_data_JH20241031.xlsx", sheet = "LoL_insectinfo")
insect_data_2024$Site <- as.factor(insect_data_2024$Site)
insect_data_2024$Site_type <- as.factor(insect_data_2024$Site_type)
insect_data_2024$Week <- as.factor(insect_data_2024$Week)
insect_data_2024$Species_sv <- as.factor(insect_data_2024$Species_sv)
insect_data_2024$Species_lt <- as.factor(insect_data_2024$Species_lt)
insect_data_2024$Order_lt <- as.factor(insect_data_2024$Order_lt)
insect_data_2024$Order_sv <- as.factor(insect_data_2024$Order_sv)
insect_data_2024$`Pollinator?` <- as.factor(insect_data_2024$`Pollinator?`)
insect_data_2024$Behaviour <- as.factor(insect_data_2024$Behaviour)

insect_data_2024 <- insect_data_2024 %>% # Here, we filter out insects that are not using the vegetation in the plot
  filter(Behaviour != "Flying by" | is.na(Behaviour))

str(insect_data_2024)

site_colors <- c("Sälg" = "goldenrod",      
                 "Bruksgräsmatta" = "#9F2B68", 
                 "Paradgräsmatta" = "#9F2B68", 
                 "Älvkant" = "#104e8b",        
                 "Ö_1" = "#458b00",           
                 "Ö_2" = "#458b00",           
                 "Ö_3" = "#458b00",           
                 "Ö_4" = "#458b00")       

sitetype_colors <- c("Sälg" = "goldenrod",      
                     "Gräsmatta" = "#9F2B68", 
                     "Älvkant" = "#104e8b",        
                     "Ö" = "#458b00")    

```

```{r build insect dataframe, include = FALSE}
df_insects_2024 <- ddply(insect_data_2024, ~ Week*Site_type*Site, summarise, 
                         SR = length(unique(Species_sv)), 
                         Abundance = length(Species_sv))

df_insects_2024 <- df_insects_2024 %>%
  mutate(Week = as.integer(as.character(Week)))

valid_combinations <- data.frame(
  Site_type = c("Sälg", "Gräsmatta", "Gräsmatta", "Älvkant", "Ö", "Ö", "Ö", "Ö"),
  Site = c("Sälg", "Paradgräsmatta", "Bruksgräsmatta", "Älvkant", "Ö_1", "Ö_2", "Ö_3", "Ö_4"))

df_insects_2024 <- df_insects_2024 %>% 
  complete(Week = 18:34, Site_type = c("Sälg", "Gräsmatta", "Älvkant", "Ö"), Site = c("Sälg", "Bruksgräsmatta", "Paradgräsmatta", "Älvkant", "Ö_1", "Ö_2", "Ö_3", "Ö_4"), fill = list(SR = 0, Abundance = 0)) %>%
  semi_join(valid_combinations, by = c("Site_type", "Site"))

df_insects_2024$Site_type <- factor(df_insects_2024$Site_type, levels = c("Sälg", "Gräsmatta", "Älvkant", "Ö"))

str(df_insects_2024)
```

```{r calculate total number of insect species and orders, include = FALSE}
insect_SR_2024 = length(unique(insect_data_2024$Species_sv))
insect_OR_2024 = length(unique(insect_data_2024$Order_lt))

print(insect_SR_2024)
print(insect_OR_2024)
```

```{r calculate total number of insects, include = FALSE}
insect_Abundance_2024 = sum(df_insects_2024$Abundance)

print(insect_Abundance_2024)
```

The number of insect species in the dataset is  `r insect_SR_2024`, divided over `r insect_OR_2024` orders. The total number of organisms is `r insect_Abundance_2024`. The species and genera that were identified are:

```{r list all insect species in 2024, include = TRUE}
list_insects_2024 = list(unique(insect_data_2024$Species_sv))

print(list_insects_2024)
```

Hi Peter! Great if you made it to here with the code, that's amazing! Can you send the knitted document and any comments/annotations you have or would like to see to me? :)